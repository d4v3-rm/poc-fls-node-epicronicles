(function(){"use strict";var L,tt;function et(){if(tt)return L;tt=1;function t(s){var e=s.length,r=1,n=new Array(e),i;for(i=e;i>0;i--)n[i-1]=r,r=r*s[i-1];return{stride:n,data:new Uint32Array(r)}}function o(s){var e=s.length,r=1,n=new Array(e),i=[],a,l;for(a=e;a>0;a--)n[a-1]=r,r=r*s[a-1];for(l=0;l<r;l++)i.push([]);return{stride:n,data:i}}return L={integer:t,array:o},L}var N,nt;function it(){if(nt)return N;nt=1,N=t;function t(o,s){var e=new Array(o),r=Math.floor(o/2)<<1,n=0,i,a,l,c,h;for(h=0;h<r;h+=2)i=-2*Math.log(s()),a=Math.sqrt(i),l=2*Math.PI*s(),n+=i,e[h]=a*Math.cos(l),e[h+1]=a*Math.sin(l);if(o%2){var u=Math.sqrt(-2*Math.log(s()))*Math.cos(2*Math.PI*s());e[o-1]=u,n+=Math.pow(u,2)}for(c=1/Math.sqrt(n),h=0;h<o;++h)e[h]*=c;return e}return N}var B,st;function wt(){return st||(st=1,B=function(o,s){o=o||1,s=s||2;for(var e=o*2+1,r=Math.pow(e,s)-1,n=new Array(r),i=0;i<r;i++)for(var a=n[i]=new Array(s),l=i<r/2?i:i+1,c=1;c<=s;c++){var h=l%Math.pow(e,c);a[c-1]=h/Math.pow(e,c-1)-o,l-=h}return n}),B}var O,rt;function ot(){if(rt)return O;rt=1;var t=wt();function o(r){var n=t(2,r),i=[],a;for(n=n.filter(function(l){for(var c=0,h=0;h<r;h++)c+=Math.pow(Math.max(0,Math.abs(l[h])-1),2);return c<r}),a=0;a<r;a++)i.push(0);return n.push(i),n.sort(function(l,c){var h=0,u=0,d;for(d=0;d<r;d++)h+=Math.pow(l[d],2),u+=Math.pow(c[d],2);return h<u?-1:h>u?1:0}),n}var s={};function e(r){return s[r]||(s[r]=o(r)),s[r]}return O=e,O}var W,at;function Mt(){if(at)return W;at=1;var t=et().integer,o=it(),s=ot();function e(n,i){for(var a=0,l=0;l<n.length;l++)a+=Math.pow(n[l]-i[l],2);return a}function r(n,i){if(typeof n.distanceFunction=="function")throw new Error("PoissonDiskSampling: Tried to instantiate the fixed density implementation with a distanceFunction");this.shape=n.shape,this.minDistance=n.minDistance,this.maxDistance=n.maxDistance||n.minDistance*2,this.maxTries=Math.ceil(Math.max(1,n.tries||30)),this.rng=i||Math.random;for(var a=0,l=0;l<this.shape.length;l++)a=Math.max(a,this.shape[l]);var c=Math.max(1,a/128|0),h=1e-14*c;this.dimension=this.shape.length,this.squaredMinDistance=this.minDistance*this.minDistance,this.minDistancePlusEpsilon=this.minDistance+h,this.deltaDistance=Math.max(0,this.maxDistance-this.minDistancePlusEpsilon),this.cellSize=this.minDistance/Math.sqrt(this.dimension),this.neighbourhood=s(this.dimension),this.currentPoint=null,this.processList=[],this.samplePoints=[],this.gridShape=[];for(var l=0;l<this.dimension;l++)this.gridShape.push(Math.ceil(this.shape[l]/this.cellSize));this.grid=t(this.gridShape)}return r.prototype.shape=null,r.prototype.dimension=null,r.prototype.minDistance=null,r.prototype.maxDistance=null,r.prototype.minDistancePlusEpsilon=null,r.prototype.squaredMinDistance=null,r.prototype.deltaDistance=null,r.prototype.cellSize=null,r.prototype.maxTries=null,r.prototype.rng=null,r.prototype.neighbourhood=null,r.prototype.currentPoint=null,r.prototype.processList=null,r.prototype.samplePoints=null,r.prototype.gridShape=null,r.prototype.grid=null,r.prototype.addRandomPoint=function(){for(var n=new Array(this.dimension),i=0;i<this.dimension;i++)n[i]=this.rng()*this.shape[i];return this.directAddPoint(n)},r.prototype.addPoint=function(n){var i,a=!0;if(n.length===this.dimension)for(i=0;i<this.dimension&&a;i++)a=n[i]>=0&&n[i]<this.shape[i];else a=!1;return a?this.directAddPoint(n):null},r.prototype.directAddPoint=function(n){var i=0,a=this.grid.stride,l;for(this.processList.push(n),this.samplePoints.push(n),l=0;l<this.dimension;l++)i+=(n[l]/this.cellSize|0)*a[l];return this.grid.data[i]=this.samplePoints.length,n},r.prototype.inNeighbourhood=function(n){var i=this.dimension,a=this.grid.stride,l,c,h,u,d;for(l=0;l<this.neighbourhood.length;l++){for(c=0,h=0;h<i;h++){if(u=(n[h]/this.cellSize|0)+this.neighbourhood[l][h],u<0||u>=this.gridShape[h]){c=-1;break}c+=u*a[h]}if(c!==-1&&this.grid.data[c]!==0&&(d=this.samplePoints[this.grid.data[c]-1],e(n,d)<this.squaredMinDistance))return!0}return!1},r.prototype.next=function(){for(var n,i,a,l,c,h,u;this.processList.length>0;){for(this.currentPoint===null&&(this.currentPoint=this.processList.shift()),l=this.currentPoint,n=0;n<this.maxTries;n++){for(h=!0,a=this.minDistancePlusEpsilon+this.deltaDistance*this.rng(),this.dimension===2?(i=this.rng()*Math.PI*2,c=[Math.cos(i),Math.sin(i)]):c=o(this.dimension,this.rng),u=0;h&&u<this.dimension;u++)c[u]=l[u]+c[u]*a,h=c[u]>=0&&c[u]<this.shape[u];if(h&&!this.inNeighbourhood(c))return this.directAddPoint(c)}n===this.maxTries&&(this.currentPoint=null)}return null},r.prototype.fill=function(){for(this.samplePoints.length===0&&this.addRandomPoint();this.next(););return this.samplePoints},r.prototype.getAllPoints=function(){return this.samplePoints},r.prototype.getAllPointsWithDistance=function(){throw new Error("PoissonDiskSampling: getAllPointsWithDistance() is not available in fixed-density implementation")},r.prototype.reset=function(){var n=this.grid.data,i=0;for(i=0;i<n.length;i++)n[i]=0;this.samplePoints=[],this.currentPoint=null,this.processList.length=0},W=r,W}var G,lt;function xt(){if(lt)return G;lt=1;var t=et().array,o=it(),s=ot();function e(n,i){for(var a=0,l=0;l<n.length;l++)a+=Math.pow(n[l]-i[l],2);return Math.sqrt(a)}function r(n,i){if(typeof n.distanceFunction!="function")throw new Error("PoissonDiskSampling: Tried to instantiate the variable density implementation without a distanceFunction");this.shape=n.shape,this.minDistance=n.minDistance,this.maxDistance=n.maxDistance||n.minDistance*2,this.maxTries=Math.ceil(Math.max(1,n.tries||30)),this.distanceFunction=n.distanceFunction,this.bias=Math.max(0,Math.min(1,n.bias||0)),this.rng=i||Math.random;for(var a=0,l=0;l<this.shape.length;l++)a=Math.max(a,this.shape[l]);var c=Math.max(1,a/128|0),h=1e-14*c;this.dimension=this.shape.length,this.minDistancePlusEpsilon=this.minDistance+h,this.deltaDistance=Math.max(0,this.maxDistance-this.minDistancePlusEpsilon),this.cellSize=this.maxDistance/Math.sqrt(this.dimension),this.neighbourhood=s(this.dimension),this.currentPoint=null,this.currentDistance=0,this.processList=[],this.samplePoints=[],this.sampleDistance=[],this.gridShape=[];for(var l=0;l<this.dimension;l++)this.gridShape.push(Math.ceil(this.shape[l]/this.cellSize));this.grid=t(this.gridShape)}return r.prototype.shape=null,r.prototype.dimension=null,r.prototype.minDistance=null,r.prototype.maxDistance=null,r.prototype.minDistancePlusEpsilon=null,r.prototype.deltaDistance=null,r.prototype.cellSize=null,r.prototype.maxTries=null,r.prototype.distanceFunction=null,r.prototype.bias=null,r.prototype.rng=null,r.prototype.neighbourhood=null,r.prototype.currentPoint=null,r.prototype.currentDistance=null,r.prototype.processList=null,r.prototype.samplePoints=null,r.prototype.sampleDistance=null,r.prototype.gridShape=null,r.prototype.grid=null,r.prototype.addRandomPoint=function(){for(var n=new Array(this.dimension),i=0;i<this.dimension;i++)n[i]=this.rng()*this.shape[i];return this.directAddPoint(n)},r.prototype.addPoint=function(n){var i,a=!0;if(n.length===this.dimension)for(i=0;i<this.dimension&&a;i++)a=n[i]>=0&&n[i]<this.shape[i];else a=!1;return a?this.directAddPoint(n):null},r.prototype.directAddPoint=function(n){var i=0,a=this.grid.stride,l=this.samplePoints.length,c;for(this.processList.push(l),this.samplePoints.push(n),this.sampleDistance.push(this.distanceFunction(n)),c=0;c<this.dimension;c++)i+=(n[c]/this.cellSize|0)*a[c];return this.grid.data[i].push(l),n},r.prototype.inNeighbourhood=function(n){var i=this.dimension,a=this.grid.stride,l,c,h,u,d,p,f=this.distanceFunction(n);for(l=0;l<this.neighbourhood.length;l++){for(c=0,h=0;h<i;h++){if(u=(n[h]/this.cellSize|0)+this.neighbourhood[l][h],u<0||u>=this.gridShape[h]){c=-1;break}c+=u*a[h]}if(c!==-1&&this.grid.data[c].length>0)for(var m=0;m<this.grid.data[c].length;m++){d=this.samplePoints[this.grid.data[c][m]],p=this.sampleDistance[this.grid.data[c][m]];var y=Math.min(p,f),P=Math.max(p,f),g=y+(P-y)*this.bias;if(e(n,d)<this.minDistance+this.deltaDistance*g)return!0}}return!1},r.prototype.next=function(){for(var n,i,a,l,c,h,u,d;this.processList.length>0;){if(this.currentPoint===null){var p=this.processList.shift();this.currentPoint=this.samplePoints[p],this.currentDistance=this.sampleDistance[p]}for(l=this.currentPoint,c=this.currentDistance,n=0;n<this.maxTries;n++){for(u=!0,a=this.minDistancePlusEpsilon+this.deltaDistance*(c+(1-c)*this.bias),this.dimension===2?(i=this.rng()*Math.PI*2,h=[Math.cos(i),Math.sin(i)]):h=o(this.dimension,this.rng),d=0;u&&d<this.dimension;d++)h[d]=l[d]+h[d]*a,u=h[d]>=0&&h[d]<this.shape[d];if(u&&!this.inNeighbourhood(h))return this.directAddPoint(h)}n===this.maxTries&&(this.currentPoint=null)}return null},r.prototype.fill=function(){for(this.samplePoints.length===0&&this.addRandomPoint();this.next(););return this.samplePoints},r.prototype.getAllPoints=function(){return this.samplePoints},r.prototype.getAllPointsWithDistance=function(){var n=new Array(this.samplePoints.length),i=0,a=0,l;for(i=0;i<this.samplePoints.length;i++){for(l=new Array(this.dimension+1),a=0;a<this.dimension;a++)l[a]=this.samplePoints[i][a];l[this.dimension]=this.sampleDistance[i],n[i]=l}return n},r.prototype.reset=function(){var n=this.grid.data,i=0;for(i=0;i<n.length;i++)n[i]=[];this.samplePoints=[],this.currentPoint=null,this.processList.length=0},G=r,G}var V,ct;function kt(){if(ct)return V;ct=1;var t=Mt(),o=xt();function s(e,r){this.shape=e.shape,typeof e.distanceFunction=="function"?this.implementation=new o(e,r):this.implementation=new t(e,r)}return s.prototype.implementation=null,s.prototype.addRandomPoint=function(){return this.implementation.addRandomPoint()},s.prototype.addPoint=function(e){return this.implementation.addPoint(e)},s.prototype.next=function(){return this.implementation.next()},s.prototype.fill=function(){return this.implementation.fill()},s.prototype.getAllPoints=function(){return this.implementation.getAllPoints()},s.prototype.getAllPointsWithDistance=function(){return this.implementation.getAllPointsWithDistance()},s.prototype.reset=function(){this.implementation.reset()},V=s,V}kt();const ht={unknown:0,revealed:1,surveyed:2},H=(t,o,s)=>{let e=!1;const r=t.systems.map(n=>n.id!==o||ht[s]<=ht[n.visibility]?n:(e=!0,{...n,visibility:s}));return e?{...t,systems:r}:t},Dt=(t,o,s)=>{const e=o.systems.find(i=>i.visibility==="unknown");if(!e)return{ship:t,galaxy:o};const r={...t,status:"traveling",targetSystemId:e.id,ticksRemaining:Math.max(1,s.travelTicks)},n=H(o,e.id,"revealed");return{ship:r,galaxy:n}},St=(t,o,s)=>{let e=t,r=o;if(e.status==="traveling"){const n=Math.max(0,e.ticksRemaining-1);e={...e,ticksRemaining:n},n===0&&e.targetSystemId&&(e={...e,status:"surveying",currentSystemId:e.targetSystemId,targetSystemId:null,ticksRemaining:Math.max(1,s.surveyTicks),localOffset:void 0},r=H(r,e.currentSystemId,"revealed"))}else if(e.status==="surveying"){const n=Math.max(0,e.ticksRemaining-1);e={...e,ticksRemaining:n},n===0&&(e={...e,status:"idle",ticksRemaining:0,localOffset:void 0},r=H(r,e.currentSystemId,"surveyed"))}return e.status==="idle"&&e.autoExplore?Dt(e,r,s):{ship:e,galaxy:r}},It=(t,o,s)=>{if(o.length===0)return{galaxy:t,scienceShips:o};let e=t;const r=o.map(n=>{const i=St(n,e,s);return e=i.galaxy,i.ship});return{galaxy:e,scienceShips:r}},M=["energy","minerals","food","research","influence"],ut=(t,o,s)=>Math.max(o,Math.min(s,t)),bt={baseStability:65,min:20,max:95,overcrowdingThreshold:2,overcrowdingPenalty:2,deficitThreshold:25,deficitPenalty:5,happinessBonusPerSpecialist:.5,happinessPenaltyPerWorker:.2},Et=(t,o,s)=>{const e=s.morale??bt,r=Math.max(0,t.size/e.overcrowdingThreshold),n=Math.max(0,t.population.total-r)*e.overcrowdingPenalty,i=M.reduce((f,m)=>{const P=o.resources[m]?.amount??0;if(P>=e.deficitThreshold)return f;const g=(e.deficitThreshold-P)/e.deficitThreshold;return f+g*e.deficitPenalty},0),a=t.habitability??1,l=a<1?Math.round((1-a)*20):0,c=e.baseStability-n-i-l,h=ut(c,e.min,e.max),u=(t.population.specialists??0)+(t.population.researchers??0),d=h+u*e.happinessBonusPerSpecialist-t.population.workers*e.happinessPenaltyPerWorker,p=ut(d,e.min,e.max);return{stability:h,happiness:p,modifier:h/100}},J=(t,o,s)=>{const e=s?.incomeMultipliers?.[o]??0;return t*(1+e)},Q=(t,o,s)=>Math.min(s,Math.max(o,t)),Tt=(t,o,s)=>{const e=M.reduce((c,h)=>(c.income[h]=0,c.upkeep[h]=0,c),{income:{},upkeep:{}}),r=new Map(o.districts.map(c=>[c.id,c])),n=new Map(o.populationJobs.map(c=>[c.id,c])),i=[];t.planets.forEach(c=>{const h=Et(c,t,o);M.forEach(u=>{const d=J((c.baseProduction[u]??0)*h.modifier,u,s),p=c.upkeep[u]??0;e.income[u]+=d,e.upkeep[u]+=p}),Object.entries(c.districts??{}).forEach(([u,d])=>{const p=r.get(u);!p||d<=0||M.forEach(f=>{const m=J((p.production[f]??0)*h.modifier,f,s),y=p.upkeep[f]??0;e.income[f]+=m*d,e.upkeep[f]+=y*d})}),n.forEach(u=>{const d=c.population[u.id]??0;d<=0||M.forEach(p=>{const f=J((u.production[p]??0)*h.modifier,p,s),m=u.upkeep[p]??0;e.income[p]+=f*d,e.upkeep[p]+=m*d})}),i.push({...c,stability:h.stability,happiness:h.happiness})});const a={...t.resources},l={energy:0,minerals:0,food:0,research:0,influence:0};return M.forEach(c=>{let h=e.income[c];const u=e.upkeep[c];c==="influence"&&(s?.influenceFlat??0)!==0&&(h+=s?.influenceFlat??0);const d=h-u;l[c]=d;const p=a[c]??{amount:0},f=Q(h,-99999,99999),m=Q(u,-99999,99999),y=Q(p.amount+d,0,999999);a[c]={amount:y,income:f,upkeep:m}}),{economy:{...t,resources:a,planets:i},netProduction:l}},F=(t,o)=>{const s=t.shipDesigns.find(e=>e.id===o);if(!s)throw new Error(`Unknown ship design: ${o}`);return s},R=(t,o)=>({id:`SHIP-${crypto.randomUUID()}`,designId:t.id,hullPoints:t.hullPoints,...o}),At=(t,o)=>({...t,id:t.id,name:`${t.name} - ${o.name}`,attack:t.attack+o.attack,defense:t.defense+o.defense,hullPoints:t.hullPoints+o.hull,buildCost:Object.fromEntries(Object.entries(t.buildCost).map(([s,e])=>[s,Math.round((e??0)*o.costMultiplier)]))}),Ft=(t,o)=>{if(!o)return t;const{attackBonus:s,defenseBonus:e,hullBonus:r,costMultiplier:n,name:i}=o;return{...t,name:i?`${t.name} - ${i}`:t.name,attack:t.attack+s,defense:t.defense+e,hullPoints:t.hullPoints+r,buildCost:Object.fromEntries(Object.entries(t.buildCost).map(([a,l])=>[a,Math.round((l??0)*n)]))}},Rt=({design:t,template:o,customization:s})=>{const e=o&&o.base===t.id?At(t,o):t;return Ft(e,s)},Z=(t,o,s="player")=>{const e=[],r=o.startingShips?.colony??0,n=o.startingShips?.military??[];if(n.length>0&&n.forEach(({designId:i,count:a})=>{const l=F(o,i);for(let c=0;c<a;c+=1)e.push(R(l))}),r>0){const i=F(o,o.colonyShipDesignId);for(let a=0;a<r;a+=1)e.push(R(i))}return{id:`FLEET-${crypto.randomUUID()}`,name:"1 Flotta",ownerId:s,systemId:t,targetSystemId:null,ticksToArrival:0,ships:e}},Ct=(t,o)=>t.techs.find(s=>s.id===o),$t=({state:t,researchIncome:o,config:s})=>{if(o<=0)return{research:t,completed:[]};const e=o*s.pointsPerResearchIncome/3,r=[],n={...t.branches},i={...t.exclusivePicks??{}};Object.entries(n).forEach(([c,h])=>{if(!h.currentTechId)return;const u=Ct(s,h.currentTechId);if(!u)return;const d=h.progress+e;d>=u.cost?(u.mutuallyExclusiveGroup&&!i[u.mutuallyExclusiveGroup]&&(i[u.mutuallyExclusiveGroup]=u.id),n[c]={...h,currentTechId:null,progress:0,completed:[...h.completed,u.id]},r.push(u)):n[c]={...h,progress:d}});const a={...t,branches:n,exclusivePicks:i},l=Ut(a,s);return{research:{...a,...l},completed:r}},Ut=(t,o)=>{const s=Object.values(t.branches).flatMap(i=>i.completed),e=new Set(t.unlockedEras);[...o.eras??[]].sort((i,a)=>i.id-a.id).forEach(i=>{if(e.has(i.id))return;const a=i.gatewayTechs??[];if(a.length===0){e.add(i.id);return}const l=Math.max(1,Math.ceil(a.length*.6));a.filter(h=>s.includes(h)).length>=l&&e.add(i.id)});const n=Math.max(...Array.from(e));return{unlockedEras:Array.from(e).sort((i,a)=>i-a),currentEra:n}},zt=(t,o)=>{const s=Array.from(new Set(o.perks.map(n=>n.era??1))).sort((n,i)=>n-i);if(s.length===0)return{currentEra:1,unlockedEras:[1]};const e=new Set([s[0]]),r=new Set(t.unlocked);for(let n=1;n<s.length;n+=1){const i=s[n-1],a=o.perks.filter(h=>(h.era??1)===i);if(a.length===0)continue;const l=a.filter(h=>r.has(h.id)).length,c=Math.max(1,Math.ceil(a.length*.6));l>=c&&e.add(s[n])}return{currentEra:Math.max(...Array.from(e)),unlockedEras:Array.from(e).sort((n,i)=>n-i)}},qt=({state:t,influenceIncome:o,config:s})=>{const e=Math.max(0,o*s.pointsPerInfluenceIncome);if(e<=0)return t;const r={...t,availablePoints:t.availablePoints+e},n=zt(r,s);return{...r,...n}},j=["preparing","traveling","colonizing"],Lt=t=>({preparing:Math.max(0,t.preparationTicks),traveling:Math.max(0,t.travelTicks),colonizing:Math.max(1,t.durationTicks)}),Nt=(t,o)=>{const s=j.indexOf(t);for(let e=s+1;e<j.length;e+=1){const r=j[e];if(o[r]>0)return r}return null},dt=t=>({id:`COL-${t.systemId}-${crypto.randomUUID()}`,name:t.planetTemplate.name,systemId:t.systemId,kind:t.planetTemplate.kind,size:t.planetTemplate.size,habitability:t.planetTemplate.habitability,population:{total:1,workers:1,specialists:0,researchers:0},baseProduction:t.planetTemplate.baseProduction,upkeep:t.planetTemplate.upkeep,districts:{},stability:60,happiness:60}),Bt=(t,o,s)=>{if(t.length===0)return{tasks:t,economy:o,completed:[]};let e=o;const r=[],n=[],i=[],a=Lt(s),l=(c,h)=>{const u=Nt(c.status,a);if(!u){const p=dt(c);n.push(p),i.push({systemId:c.systemId,planetName:p.name});return}const d=a[u];r.push({...c,status:u,ticksRemaining:d,totalTicks:d,missionElapsedTicks:h})};return t.forEach(c=>{const h=c.ticksRemaining-1,u=Math.min(c.missionTotalTicks,c.missionElapsedTicks+1);if(h>0){r.push({...c,ticksRemaining:h,missionElapsedTicks:u});return}if(c.status==="colonizing"){n.push(dt(c)),i.push({systemId:c.systemId,planetName:c.planetTemplate.name});return}l(c,u)}),n.length>0&&(e={...e,planets:[...e.planets,...n]}),{tasks:r,economy:e,completed:i}},Ot=({tasks:t,fleets:o,scienceShips:s,military:e,fallbackSystemId:r})=>{if(t.length===0)return{tasks:t,fleets:o,scienceShips:s};let n=o,i=s,a=!1,l=!1;const c=p=>{try{return F(e,p).role??"military"}catch{return"military"}},h=p=>{const f=n.find(g=>g.ships.some(w=>c(w.designId)===p));if(f)return a||(n=n.map(g=>({...g,ships:[...g.ships]})),a=!0),n.find(g=>g.id===f.id);const m=n.filter(g=>g.ships.some(w=>c(w.designId)===p)).length,y=p==="construction"?"Flotta Costruttrice":p==="colony"?"Flotta Colonia":"Flotta Militare",P={id:`FLEET-${crypto.randomUUID()}`,name:`${y} ${m+1}`,ownerId:"player",systemId:r,targetSystemId:null,ticksToArrival:0,ships:[]};return n=a?[...n,P]:[...n,P],a=!0,P},u=()=>(n.length===0?(n=[Z(r,e)],a=!0):a||(n=n.map(p=>({...p,ships:[...p.ships]})),a=!0),n[0]),d=[];return t.forEach(p=>{const f=Math.max(0,p.ticksRemaining-1);if(f===0){const m=F(e,p.designId),y=p.templateId?e.templates.find(g=>g.id===p.templateId):e.templates.find(g=>g.base===m.id),P=Rt({design:m,template:y,customization:p.customization});if(m.role==="science")l||(i=[...i],l=!0),i.push({id:`SCI-${crypto.randomUUID()}`,name:P.name??m.name,currentSystemId:r,targetSystemId:null,status:"idle",ticksRemaining:0,autoExplore:!0});else{const g=m.role??"military";(g==="construction"||g==="colony"||g==="military"?h(g):u()).ships.push(R(P))}}else d.push({...p,ticksRemaining:f})}),{tasks:d,fleets:n,scienceShips:i}},pt=t=>new Map(t.military.shipDesigns.map(o=>[o.id,o])),Wt=t=>({...t,ships:t.ships.map(o=>({...o}))}),Gt=(t,o,s)=>{if(o<=0)return{survivors:t,shipsLost:0};const e=[];let r=o,n=0;return t.forEach(i=>{const l=s.get(i.designId)?.hullPoints??i.hullPoints,c=i.hullPoints;r>=c?(r-=c,n+=1):(e.push({...i,hullPoints:Math.min(l,c-r)}),r=0)}),{survivors:e,shipsLost:n}},_=(t,o)=>t.ships.reduce((s,e)=>{const r=o.get(e.designId),n=e.attackBonus??0;return s+(r?.attack??0)+n},0),Vt=(t,o)=>t.ships.reduce((s,e)=>{const r=o.get(e.designId);return s+(r?.defense??0)},0),Ht=(t,o)=>{const s=pt(o);return t.filter(e=>!e.ownerId||e.ownerId==="player").reduce((e,r)=>e+_(r,s),0)},Jt=({fleets:t,galaxy:o,config:s,fallbackSystemId:e,tick:r})=>{if(t.length===0)return{fleets:t,galaxy:o,reports:[],hostilesCleared:[]};const n=pt(s);let i=o.systems,a=!1;const l=[],c=t.map(Wt),h=[],u=new Map;i.forEach((m,y)=>{u.set(m.id,y)});const d=m=>u.get(m)??-1,p=()=>{a||(i=i.map(m=>({...m})),a=!0)};return c.forEach(m=>{if(m.targetSystemId&&m.ticksToArrival>0&&(m.ticksToArrival=Math.max(0,m.ticksToArrival-1),m.ticksToArrival===0&&(m.systemId=m.targetSystemId,m.targetSystemId=null,m.localOffset=void 0)),m.ships.length===0)return;const y=d(m.systemId);if(y<0)return;const P=i[y],g=P.hostilePower??0;if(g<=0)return;p();const w=_(m,n),C=Vt(m,n),X=w,$=Math.max(0,g-Math.round(C*.5)),k=Math.max(0,g-X),U=Gt(m.ships,$,n);m.ships=U.survivors;const z=U.shipsLost;let x="playerVictory";k<=0&&m.ships.length===0?x="mutualDestruction":k>0&&m.ships.length===0?x="playerDefeat":k>0&&m.ships.length>0&&(x="stalemate"),i[y]={...P,hostilePower:Math.max(0,k)},k<=0&&h.push(P.id),l.push({id:`COMBAT-${P.id}-${r}-${crypto.randomUUID()}`,systemId:P.id,tick:r,playerPower:w,playerDefense:C,damageTaken:$,hostilePower:g,result:x,losses:[{fleetId:m.id,shipsLost:z}]}),m.ships.length===0&&(m.targetSystemId=null,m.ticksToArrival=0)}),{fleets:c.length>0?c:[Z(e,s.military)],galaxy:a?{...o,systems:i}:o,reports:l,hostilesCleared:h}},mt=(t,o)=>t.systems.find(s=>s.id===o),ft=(t,o,s,e)=>{if(t===o)return 0;const r=mt(s,t),n=mt(s,o);if(!r||!n)return e.baseTravelTicks;const i=n.position.x-r.position.x,a=n.position.y-r.position.y,c=Math.sqrt(i*i+a*a)/60;return Math.max(1,Math.round(e.baseTravelTicks+c))},Qt=(t,o)=>({...t,districts:{...t.districts,[o]:(t.districts[o]??0)+1}}),Zt=({tasks:t,economy:o,config:s})=>{if(t.length===0)return{tasks:t,economy:o,completed:[]};const e=[];let r=o;const n=[];return t.forEach(i=>{const a=Math.max(0,i.ticksRemaining-1);if(a===0){n.push(i);const l=r.planets.find(u=>u.id===i.planetId),c=s?.districts.find(u=>u.id===i.districtId);r=!c?.requiresColonists||(l?.population.total??0)>=(c.requiresColonists??0)?{...r,planets:r.planets.map(u=>u.id===i.planetId?Qt(u,i.districtId):u)}:r}else e.push({...i,ticksRemaining:a})}),{tasks:e,economy:r,completed:n}},D=(t,o)=>{const s=t.production[o]??0,e=t.upkeep[o]??0;return s-e},jt=()=>({energy:0,minerals:0,food:0,research:0,influence:0}),_t=t=>({...t.population}),Yt=({planet:t,workerJob:o,bestJobs:s,deficitTargets:e,surplusTargets:r,priorities:n,automation:i})=>{const a=_t(t);let l=!1;const c=(h,u)=>{a[h]=Math.max(0,(a[h]??0)-1),a[u]=(a[u]??0)+1,l=!0};return n.forEach(h=>{let u=e[h];if(u===void 0||u<=i.deficitThreshold)return;const d=s.get(h);if(!d||d.id==="workers")return;const p=D(d,h)-D(o,h);if(p<=0||a.workers<=0)return;const f=Math.min(a.workers,Math.ceil(u/p));if(!(f<=0))for(let m=0;m<f&&!(a.workers<=0||(c("workers",d.id),u=Math.max(0,u-p),e[h]=u,u<=i.deficitThreshold));m+=1);}),n.forEach(h=>{let u=r[h];if(u===void 0||u<=i.surplusThreshold)return;const d=s.get(h);if(!d||d.id==="workers")return;const p=a[d.id]??0;if(p<=0)return;const f=D(d,h)-D(o,h);if(f<=0)return;const m=Math.min(p,Math.ceil((u-i.surplusThreshold)/f));if(!(m<=0))for(let y=0;y<m&&!((a[d.id]??0)<=0||(c(d.id,"workers"),u=Math.max(i.surplusThreshold,u-f),r[h]=u,u<=i.surplusThreshold));y+=1);}),l?{...t,population:a}:t},Kt=({economy:t,config:o})=>{const s=o.populationAutomation;if(!s?.enabled)return t;const e=o.populationJobs.find(h=>h.id==="workers");if(!e)return t;const r=jt();M.forEach(h=>{const u=t.resources[h],d=u?.income??0,p=u?.upkeep??0;r[h]=d-p});const n={},i={};let a=!1;if(s.priorities.forEach(h=>{const u=r[h]??0;u<-s.deficitThreshold?(n[h]=Math.abs(u),a=!0):u>s.surplusThreshold&&(i[h]=u,a=!0)}),!a)return t;const l=new Map;M.forEach(h=>{const u=o.populationJobs.reduce((d,p)=>{if(p.id==="workers")return d;const f=D(p,h);if(f<=0)return d;if(!d)return p;const m=D(d,h);return f>m?p:d},null);u&&l.set(h,u)});const c=t.planets.map(h=>Yt({planet:h,workerJob:e,bestJobs:l,deficitTargets:n,surplusTargets:i,priorities:s.priorities,automation:s}));return{...t,planets:c}},Xt=()=>({incomeMultipliers:{},influenceFlat:0}),yt=(t,o)=>{const[s,e]=t.split(":"),r=Number(e);if(!Number.isNaN(r))switch(s){case"energyIncome":case"mineralsIncome":case"foodIncome":case"researchIncome":{const n=s.replace("Income",""),i=o.incomeMultipliers[n]??0;o.incomeMultipliers[n]=i+r;break}case"influenceFlat":{o.influenceFlat+=r;break}}},te=({research:t,traditions:o,researchConfig:s,traditionConfig:e})=>{const r=Xt();return s.techs.filter(a=>t.branches[a.branch].completed.includes(a.id)).forEach(a=>{(a.effects??[]).forEach(l=>yt(l,r))}),e.perks.filter(a=>o.unlocked.includes(a.id)).forEach(a=>{(a.effects??[]).forEach(l=>yt(l,r))}),r},I=t=>t.length===0?null:t[Math.floor(Math.random()*t.length)],Y=(t,o)=>({...t,id:`${t.id}-${crypto.randomUUID()}`,systemId:o??null,resolvedOptionId:null}),ee=t=>{const o=t.narrative,s=I(o);return s?Y(s):null},ne=(t,o)=>{const s=I(t.anomalies);return s?Y(s,o):null},ie=(t,o)=>{const s=I(t.crisis);return s?Y(s,o):null},se=({session:t,config:o,tick:s})=>{const e=t.events.log.at(-1)?.tick??null;if(e!==null&&s-e<8)return null;const r=t.warEvents.length>0?t.warEvents[t.warEvents.length-1].tick:null;if(r!==null&&s-r<5||t.notifications.some(n=>n.kind==="eventStarted"&&s-n.tick<4)||t.warEvents.length>0&&Math.random()<.2)return null;if(s>40&&s%o.crisisIntervalTicks===0){const n=I(t.galaxy.systems.filter(i=>i.visibility==="surveyed"));return n?ie(o,n.id):null}if(s>15&&s%o.anomalyIntervalTicks===0){const n=I(t.galaxy.systems.filter(i=>i.visibility==="surveyed"&&(i.hostilePower??0)===0));return n?ne(o,n.id):null}return s>10&&s%o.narrativeIntervalTicks===0?ee(o):null},re=t=>Math.max(-100,Math.min(100,t)),oe=({empires:t,config:o,tick:s,playerFleetPower:e=0})=>{if(t.length<=1)return{empires:t,notifications:[],warsStarted:[],warsEnded:[]};if(s%Math.max(1,o.autoCheckInterval)!==0)return{empires:t,notifications:[],warsStarted:[],warsEnded:[]};const r=[],n=[],i=[],a=t.map(l=>({...l}));return a.forEach(l=>{if(l.kind==="player")return;const c=re(l.opinion+o.opinionDriftPerCheck);l.opinion=c,l.warStatus==="peace"&&c<=o.warThreshold?(l.warStatus="war",l.warSince=s,n.push(l.id),r.push({id:`notif-${crypto.randomUUID()}`,tick:s,kind:"warDeclared",message:`${l.name} ha dichiarato guerra!`})):l.warStatus==="war"&&(c>=o.peaceThreshold||he({empire:l,playerFleetPower:e}))&&(l.warStatus="peace",l.warSince=null,i.push(l.id),r.push({id:`notif-${crypto.randomUUID()}`,tick:s,kind:"peaceAccepted",message:`${l.name} accetta una tregua.`}))}),{empires:a,notifications:r,warsStarted:n,warsEnded:i}},ae=({galaxy:t,warsStarted:o,tick:s,config:e})=>{if(o.length===0)return t;const r=t.systems.slice(),n=Math.max(1,r.length-1);return o.forEach((i,a)=>{for(let l=0;l<e.count;l+=1){const c=1+(s+a*3+l)%n,h=r[c];if(!h)continue;const u=Math.max(1,e.powerMax-e.powerMin),d=e.powerMin+(s+l+a)%u;r[c]={...h,hostilePower:Math.max(h.hostilePower??0,d)}}}),{...t,systems:r}},le=(t,o)=>{if(o.size===0)return t;const s=t.systems.map((e,r)=>r===0||o.has(e.id)?{...e,ownerId:"player"}:(e.ownerId&&e.ownerId!=="player",e));return{...t,systems:s}},ce=({galaxy:t,empires:o,tick:s,config:e})=>{const r=o.filter(a=>a.kind==="ai"&&a.warStatus==="war");if(r.length===0||s%8!==0)return t;const n=t.systems.slice(),i=Math.max(1,n.length-1);return r.forEach((a,l)=>{const c=1+(s+l)%i,h=n[c];if(!h)return;const u=Math.max(1,e.powerMax-e.powerMin),d=e.powerMin+(s+l)%u;n[c]={...h,hostilePower:Math.max(h.hostilePower??0,d)}}),{...t,systems:n}},he=({empire:t,playerFleetPower:o})=>{const s=Math.abs(t.opinion);return t.opinion>-20&&o>12||s<15},gt=t=>{const o=t.shipDesigns.filter(s=>(s.role??"military")==="military");return o.length>0?o:t.shipDesigns},vt=({galaxy:t,avoidSystemIds:o,preferHostile:s,fleetPower:e})=>{const r=t.systems.filter(i=>(i.hostilePower??0)>0&&!o.includes(i.id)).sort((i,a)=>(a.hostilePower??0)-(i.hostilePower??0));if(s){const i=r.find(a=>(a.hostilePower??0)<=e*1.6);if(i)return i.id}if(r.length>0)return r[0]?.id??null;const n=t.systems.filter(i=>(i.hostilePower??0)===0&&!o.includes(i.id));return n.length===0?null:n[Math.floor(Math.random()*n.length)]?.id??null},ue=(t,o,s)=>{const e=t.galaxy.systems.filter(p=>(p.hostilePower??0)>0).length,r=t.galaxy.systems.reduce((p,f)=>p+(f.hostilePower??0),0),n=e>=5?3:e>=3?2:1,i=t.fleets.filter(p=>p.ownerId&&p.ownerId!=="player");if(i.length>=n)return t;const a=t.galaxy.systems[1]?.id??t.galaxy.systems[0]?.id;if(!a||t.fleets.some(p=>p.ownerId==="ai-1"))return t;const l=gt(o),c=s.aiFleetStrength.baseShips+Math.min(e*s.aiFleetStrength.extraPerHostile,s.aiFleetStrength.maxShips),h=Math.min(6,Math.floor(r/Math.max(1,s.aiFleetStrength.attackBonusPerThreat))),u=[];for(let p=0;p<c;p+=1){const f=l[p%l.length],m=e>=5?6:e>=3?3:e>=1?1:0;u.push({id:`SHIP-${crypto.randomUUID()}`,designId:f.id,hullPoints:f.hullPoints+m,attackBonus:Math.max(0,h)})}const d={...Z(a,o,"ai-1"),name:`Flotta AI ${i.length+1}`,ships:u};return{...t,fleets:[...t.fleets,d]}},de=(t,o,s)=>{const e=t.galaxy.systems.filter(l=>(l.hostilePower??0)>0).length,r=s.aiFleetStrength.baseShips+Math.min(e*s.aiFleetStrength.extraPerHostile,s.aiFleetStrength.maxShips),n=gt(o),i=t.fleets.map(l=>({...l,ships:[...l.ships]}));let a=!1;return i.forEach(l=>{if(!(!l.ownerId||l.ownerId==="player"))for(;l.ships.length<r;){const c=n[l.ships.length%n.length];l.ships.push(R(c,{attackBonus:e>=3?2:0})),a=!0}}),a?{...t,fleets:i}:t},pe=({session:t,military:o})=>{const s=t.empires.filter(n=>n.kind==="ai"&&n.warStatus==="war");if(s.length===0)return t;const e=t.fleets.map(n=>({...n}));let r=!1;return s.forEach(n=>{const i=e.find(f=>f.ownerId===n.id);if(!i||i.targetSystemId)return;const a=t.galaxy.systems.find(f=>f.id===i.systemId)??null,l=_(i,new Map(o.shipDesigns.map(f=>[f.id,f]))),c=a?.hostilePower??0,h=t.galaxy.systems[1]??t.galaxy.systems[0];if(c>l*1.25&&h){const f=ft(i.systemId,h.id,t.galaxy,o.fleet);i.targetSystemId=h.id,i.ticksToArrival=Math.max(1,f),r=!0;return}const u=[i.systemId];i.lastTargetSystemId&&u.push(i.lastTargetSystemId);const d=vt({galaxy:t.galaxy,avoidSystemIds:u,preferHostile:!0,fleetPower:l})??vt({galaxy:t.galaxy,avoidSystemIds:u,preferHostile:!1,fleetPower:l})??t.galaxy.systems[0]?.id??null;if(!d||d===i.systemId)return;const p=ft(i.systemId,d,t.galaxy,o.fleet);i.targetSystemId=d,i.ticksToArrival=Math.max(1,p),i.lastTargetSystemId=d,r=!0}),r?{...t,fleets:e}:t},me=(t,o)=>{const s=o.find(n=>n.kind==="ai");if(!s)return t;const e=t.systems.find(n=>!n.ownerId&&n.habitableWorld&&(n.hostilePower??0)===0);if(!e)return t;const r=t.systems.map(n=>n.id===e.id?{...n,ownerId:s.id}:n);return{...t,systems:r}},fe={playerVictory:"Vittoria",playerDefeat:"Sconfitta",mutualDestruction:"Mutua distruzione",stalemate:"Stallo"},ye=t=>{const o=t.systems.map(s=>{if(!s.shipyardBuild)return s;const e=Math.max(0,s.shipyardBuild.ticksRemaining-1);return e<=0?{...s,ownerId:s.ownerId??"player",hasShipyard:!0,shipyardAnchorPlanetId:s.shipyardBuild.anchorPlanetId??null,shipyardBuild:void 0}:{...s,shipyardBuild:{...s.shipyardBuild,ticksRemaining:e}}});return{...t,systems:o}},ge=(t,o,s)=>{if(o<=0)return t;let e=t;for(let r=0;r<o;r+=1){const n=[],i=[...e.warEvents],a=te({research:e.research,traditions:e.traditions,researchConfig:s.research,traditionConfig:s.traditions}),l=e.fleets[0]?.systemId??e.galaxy.systems[0]?.id??"unknown",c=e.clock.tick+r+1;e=ue(e,s.military,s.diplomacy),e=de(e,s.military,s.diplomacy);const h=Bt(e.colonizationTasks,e.economy,s.colonization);let u=e.galaxy;const d=new Set(h.economy.planets.map(v=>v.systemId));h.completed.forEach(v=>d.add(v.systemId)),d.size>0&&(u=le(u,d)),u=me(u,e.empires);const p=Zt({tasks:e.districtConstructionQueue,economy:h.economy});h.completed.length>0&&h.completed.forEach(v=>{n.push({id:`notif-${crypto.randomUUID()}`,tick:e.clock.tick+r+1,kind:"colonizationCompleted",message:`Colonia fondata in ${v.planetName} (${v.systemId}).`})}),p.completed.length>0&&p.completed.forEach(v=>{const E=p.economy.planets.find(A=>A.id===v.planetId),T=s.economy.districts.find(A=>A.id===v.districtId);n.push({id:`notif-${crypto.randomUUID()}`,tick:e.clock.tick+r+1,kind:"districtComplete",message:`Distretto ${T?.label??v.districtId} completato su ${E?.name??v.planetId}`})});const f=Ot({tasks:e.shipyardQueue,fleets:e.fleets,scienceShips:e.scienceShips,military:s.military,fallbackSystemId:l}),m=Jt({fleets:f.fleets,galaxy:u,config:s,fallbackSystemId:l,tick:c});m.reports.length>0&&m.reports.forEach(v=>{const E=m.galaxy.systems.find(A=>A.id===v.systemId)?.name??v.systemId,T=fe[v.result]??v.result;n.push({id:`notif-${crypto.randomUUID()}`,tick:v.tick,kind:"combatReport",message:`Combattimento a ${E}: ${T} (forza ${v.playerPower} vs ${v.hostilePower}).`})}),m.hostilesCleared.length>0&&m.hostilesCleared.forEach(v=>{const E=m.galaxy.systems.find(T=>T.id===v)?.name??v;n.push({id:`notif-${crypto.randomUUID()}`,tick:c,kind:"combatReport",message:`Minaccia neutralizzata in ${E}.`})});const y=oe({empires:e.empires,config:s.diplomacy,tick:c,playerFleetPower:Ht(m.fleets,s)});y.notifications.length>0&&n.push(...y.notifications),y.warsStarted.length>0&&y.warsStarted.forEach(v=>{i.push({id:`war-${crypto.randomUUID()}`,type:"warStart",empireId:v,tick:c,message:"Guerra dichiarata."})}),y.warsEnded.length>0&&y.warsEnded.forEach(v=>{i.push({id:`war-${crypto.randomUUID()}`,type:"warEnd",empireId:v,tick:c,message:"Pace raggiunta."})});const P=ae({galaxy:m.galaxy,warsStarted:y.warsStarted,tick:c,config:s.diplomacy.warZones}),g=ce({galaxy:P,empires:y.empires,tick:c,config:s.diplomacy.warZones}),w=pe({session:{...e,fleets:m.fleets,galaxy:g},military:s.military}),C=ye(g),{galaxy:X,scienceShips:$}=It(C,f.scienceShips,s.exploration),k=Kt({economy:p.economy,config:s.economy}),{economy:U,netProduction:z}=Tt(k,s.economy,a),x=$t({state:e.research,researchIncome:Math.max(0,z.research),config:s.research}),ve=qt({state:e.traditions,influenceIncome:Math.max(0,z.influence),config:s.traditions});x.completed.length>0&&x.completed.forEach(v=>{n.push({id:`notif-tech-${v.id}-${c}`,tick:c,kind:"combatReport",message:`Ricerca completata: ${v.name}.`})});let b=e.events.queue,S=e.events.active;!S&&b.length>0&&(S=b[0],b=b.slice(1));const q=S===null?se({session:e,config:s.events,tick:c}):null,Pt=q!==null?{id:`notif-evt-${q.id}`,tick:c,kind:"eventStarted",message:`Nuovo evento: ${q.title}`}:null;Pt&&n.push(Pt),S=S??q??null,e={...e,galaxy:X,scienceShips:$,empires:y.empires,research:x.research,traditions:ve,events:{active:S,queue:b,log:e.events.log},warEvents:i.slice(-s.diplomacy.warEventLogLimit),colonizationTasks:h.tasks,districtConstructionQueue:p.tasks,shipyardQueue:f.tasks,fleets:w.fleets,combatReports:[...e.combatReports,...m.reports].slice(-8),notifications:[...e.notifications,...n].slice(-6),economy:U}}return e},K=self;K.onmessage=t=>{const o=t.data;if(o.type!=="simulate")return;const{id:s,session:e,ticks:r,config:n}=o,i=ge(e,r,n),a={type:"result",id:s,session:i};K.postMessage(a)},K.postMessage({type:"ready"})})();
